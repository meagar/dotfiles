# enable tab-completion by adding to .bash_profile:
# _git_squash() {
#   __gitcomp_nl "$(__git_refs)"
# }
# complete -F __git_wrap__git_main git-squash

if [ -n "$1" ]; then
  DEST="$1"
else
  DEST=$(git rev-parse --abbrev-ref origin/HEAD 2>/dev/null) || DEST="origin/main"
fi
echo "Squashing onto $DEST"

DIRTY="false"
if [[ -n $(git status --porcelain -uno) ]]; then
  DIRTY="true"
fi

if [ "$DIRTY" = "true" ]; then
  echo "Stashing changes"
  git stash
fi

OLD_HEAD=$(git rev-parse HEAD)
echo "The current commit is ${OLD_HEAD}"

git fetch && git reset --hard "$DEST" && git merge --squash "$OLD_HEAD" && git commit

# Cleanup - restore stash, if necessary
if [ "$DIRTY" = "true" ]; then
  echo "Unstashing changes"
  git stash pop
fi

